{% extends 'base.html' %}
{% block content %}
<div class="grid-2">
	<div class="card">
		<h3>{{ tr.submit_heading }}</h3>
		{% if user_mobile %}
		<form id="petitionForm">
			<div class="grid-2">
				<label><span>{{ tr.petitioner_name }}</span>
					<input name="petitioner_name" required>
				</label>
				<label><span>{{ tr.dob }}</span>
					<input name="petitioner_dob" type="date" required>
				</label>
			</div>
			<div class="grid-3">
				<label><span>{{ tr.taluk }}</span>
					<select name="taluk" id="taluk" required></select>
				</label>
				<label><span>{{ tr.firka }}</span>
					<select name="firka" id="firka" required></select>
				</label>
				<label><span>{{ tr.village }}</span>
					<select name="village" id="village" required></select>
				</label>
			</div>
			<label><span>{{ tr.description }}</span>
				<textarea name="description" required></textarea>
			</label>
			<div class="actions">
				<button type="submit">{{ tr.submit_btn }}</button>
			</div>
		</form>
		{% else %}
		<p>{{ tr.login_prompt }}</p>
		{% endif %}
	</div>
	<div class="card">
		<h3>{{ tr.guidelines_title }}</h3>
		<p class="helper">- {{ tr.guideline_1 }}</p>
		<p class="helper">- {{ tr.guideline_2 }}</p>
		<p class="helper">- {{ tr.guideline_3 }}</p>
	</div>
</div>

<div class="card" style="margin-top:1rem;">
	<h3>{{ tr.my_petitions_title }}</h3>
	{% if my_complaints and my_complaints|length > 0 %}
	<table class="table">
		<thead><tr><th>ID</th><th>{{ tr.name_col }}</th><th>{{ tr.location_col }}</th><th>{{ tr.description }}</th><th>{{ tr.response_col }}</th><th>{{ tr.status_col }}</th><th>{{ tr.created_col }}</th><th>{{ tr.download_col }}</th></tr></thead>
		<tbody>
		{% for c in my_complaints %}
		<tr>
			<td>{{ c[0] }}</td>
			<td>{{ c[2] }}</td>
			<td>{{ c[5] }} / {{ c[6] }} / {{ c[7] }}</td>
			<td>{{ c[8] }}</td>
			<td>{{ c[9] or '-' }}</td>
			<td>
				<span class="badge {% if c[10]=='Pending' %}pending{% elif c[10]=='In Progress' %}inprogress{% elif c[10]=='Resolved' %}resolved{% else %}rejected{% endif %}" title="{{ status_text(c[10]) }}">{{ status_text(c[10]) }}</span>
			</td>
			<td>{{ c[11] }}</td>
			<td><a class="btn secondary" href="/petition/{{ c[0] }}/download" download="petition-{{ c[0] }}.pdf">{{ tr.download_col }}</a></td>
		</tr>
		{% endfor %}
		</tbody>
	</table>
	{% else %}
	<p>{{ tr.no_petitions }}</p>
	{% endif %}
</div>

<script>
async function loadLocations(){
	const res = await fetch('/locations');
	const loc = await res.json();
	const talukSel = document.getElementById('taluk');
	const firkaSel = document.getElementById('firka');
	const villageSel = document.getElementById('village');
	talukSel.innerHTML = '<option value="">-- {{ tr.select }} --</option>' + Object.keys(loc).map(t=>`<option value="${t}">${t}</option>`).join('');
	talukSel.onchange = () => {
		const f = loc[talukSel.value] || {};
		firkaSel.innerHTML = '<option value="">-- {{ tr.select }} --</option>' + Object.keys(f).map(x=>`<option value="${x}">${x}</option>`).join('');
		villageSel.innerHTML = '<option value="">-- {{ tr.select }} --</option>';
	};
	firkaSel.onchange = () => {
		const villages = (loc[talukSel.value]||{})[firkaSel.value] || [];
		villageSel.innerHTML = '<option value="">-- {{ tr.select }} --</option>' + villages.map(v=>`<option value="${v}">${v}</option>`).join('');
	};
}
loadLocations();

const form = document.getElementById('petitionForm');
if(form){
	form.addEventListener('submit', async (e)=>{
		e.preventDefault();
		const fd = new FormData(form);
		const res = await fetch('/submit', { method: 'POST', body: fd });
		const data = await res.json();
		if(data.status==='success'){
			alert('Registered. Petition ID: '+data.complaint_id);
			location.reload();
		}else{
			alert(data.message||'Error');
		}
	});
}
</script>
{% endblock %}
